require(GeneFamilies)
options(mc.cores = getMcCores())
library(dotenv)

output_data_dir <- Sys.getenv("OUTPUT_DATA_DIR")

message("USAGE: Rscript path/2/GeneFamilies/exec/loadGeneFamilies.R path/2/GeneFamilies/data mcl_output.txt mcl_table.tsv")
message("EXPECTED INPUT FORMATS:")
message(" - mcl_output.txt is the textual output generated by the markob clustering tool mcl used on the all vs all sequence similarity search results. A single cluster (family) is expected per line and gene members to be separated by TAB.")
message(" - mcl_table a TAB separated table with the following header:\nid A.thaliana A.lyrata C.rubella C.hirsuta A.arabicum B.rapa E.salsugineum S.parvula")

readMclOutputTest <- function(path.2.mcl.out, family.name.prefix = "cluster_") {
    sys.cmd <- paste("awk 'NR==1 {cluster=\"", family.name.prefix, "\" NR; for (i = 1; i <= NF; i++) { print cluster \"\\t\" $i }} NR>1 {cluster=\"",
    family.name.prefix, "\" NR; for (i = 2; i <= NF; i++) { print cluster \"\\t\" $i }}' ",
        path.2.mcl.out, sep = "")
    fread(sys.cmd, stringsAsFactors = FALSE, sep = "\t",
        colClasses = rep("character", 2),
        col.names = c("Family", "Gene"), na.strings = "",
        data.table = FALSE)
}

input.args <- commandArgs(trailingOnly = TRUE)

families.genes.df <- readMclOutputTest(input.args[[1]])
# print(families.genes.df)
families.lst <- mclDataFrameAsList(families.genes.df)
# print(families.lst)
families.df <- read.table(input.args[[2]], sep = "\t", header = TRUE, stringsAsFactors = FALSE,
    comment.char = "", quote = "", na.strings = "", colClasses = c("character", rep("numeric",
        1)))
families.df$size <- families.df$dmel

#' Save parsed data:
save(families.genes.df, families.lst, families.df, file = file.path(output_data_dir, 
    "families.RData"))

message("DONE")
